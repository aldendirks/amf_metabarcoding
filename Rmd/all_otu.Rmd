---
title: "Effects of N Addition on AMF Diversity in WI Switchgrass Cropping Systems"
subtitle: "All Sites - Analysis of OTUs"
author: "Alden Dirks"
date: "7/26/2019"
output: html_document
---

```{r setup, include=FALSE}
rm(list = ls()) # clean up environment for new session
knitr::opts_knit$set(root.dir = '..' ) # set markdown root directory to project root
knitr::opts_chunk$set(echo = TRUE, fig.path = '../figures/', message = FALSE, warning = FALSE)
```

```{r libraries, results = 'hide'}
library("Biostrings"); packageVersion("Biostrings") # version 2.52.0
library("DESeq2"); packageVersion("DESeq2") # version 1.24.0
library("gridExtra"); packageVersion("gridExtra") # version 2.3
library("lme4"); packageVersion("lme4") # version 1.1.21
library("lmerTest"); packageVersion("lmerTest") # version 3.1.0
library("party"); packageVersion("party") # version 1.3.3
library("phyloseq"); packageVersion("phyloseq") # version 1.28.0
library("randomForest"); packageVersion("randomForest") # version 4.6.14
library("rpart"); packageVersion("rpart") # version 4.1.15
library("tidyverse"); packageVersion("tidyverse") # version 1.2.1
```

```{r paths}
path_data = file.path("data", "seqs", "cleaned")
path_master = file.path("data")
```

```{r load_data}
asv <- read.table(file.path(path_data, "ASVs_counts.csv"), header = TRUE, check.names = FALSE, sep = ",")
fas <- readDNAStringSet(file.path(path_data, "ASVs.fasta"))
info <- read.table(file.path(path_data, "sample_info.csv"), header = TRUE, check.names = FALSE, sep = ",")
info$block <- info$site:info$block
master <- read.table(file.path(path_master, "master_otu.csv"), header = TRUE, check.names = FALSE, sep = ",")
tax <- as.matrix(read.table(file.path(path_data, "ASVs_taxonomy.csv"), header = TRUE, row.names = 1, check.names = FALSE, sep = ","))
otu <- master[,28:120]
```

## Visualization of OTUs

```{r all_sites_box_plots}
ggplot(master, aes(x = site, y = div_rich, fill = nitrogen)) + geom_boxplot() + labs(y = "ASV Richness", x = "Site")
ggplot(master, aes(x = site, y = div_shan, fill = nitrogen)) + geom_boxplot() + labs(y = "ASV Shannon Index", x = "Site")
ggplot(master, aes(x = site, y = div_simp, fill = nitrogen)) + geom_boxplot() + labs(y = "ASV Simpson's Index", x = "Site")
```

## Linear Mixed Effects Regression Analysis

* Biomass differs significantly by site (p = 0.0002464) and by N treatment (p = 0.0209347). There is no interaction (p = 0.1395920). Biomass across the sites is as follows: Oregon > Rhinelander > Hancock, as we would expect given our knowledge of the soil fertility of each site. N amendment increases biomass.
* There is a significant site*nitrogen interaction for yield (p = 0.005733). Nitrogen amendment does not significantly affect yield at Hancock (p = 0.500882, B corrected p = 1.0) or Oregon (p = 0.071604, B corrected p = 0.214812) but it signiicantly increases it at Rhinelander (p = 0.002268, B corrected p = 0.006804).
* Plant height in September did not differ by site or nitrogen treatment and there was no interaction.
* Lodging frequency differed by site (p = 0.001885) with Oregon having a greater frequency of lodging than Rhinelander and Hancock. 

```{r lmer_agr, results = 'hide', eval = FALSE}
lmer_biomass <- lmer(biomass ~ site*nitrogen + (1|block:site), data = master, REML = FALSE); summary(lmer_biomass); anova(lmer_biomass); difflsmeans(lmer_biomass)
lmer_yield <- lmer(yield ~ site*nitrogen + (1|block:site), data = master); anova(lmer_yield); difflsmeans(lmer_yield)
lmer_height <- lmer(height ~ site*nitrogen + (1|block:site), data = master); anova(lmer_height); difflsmeans(lmer_height)
lmer_lodged <- lmer(lodged ~ site*nitrogen + (1|block:site), data = master); anova(lmer_lodged); difflsmeans(lmer_lodged)
```

* pH, percent C, percent N, C:N ratio, and cation exchange capacity differ significantly by site. 
* There was actually a significant site by nitrogen interaction for phosphorus (p = 0.04241). Rhinelander and Oregon did not differ significantly with the addition of N, but Hancock did (p = 0.0214789). However, when corrected for multiple comparisons, this was no longer significant (p = 0.0644367).

```{r lmer_soil, results = 'hide', eval = FALSE}
lmer_ph <- lmer(ph ~ site*nitrogen + (1|block:site), data = master); anova(lmer_ph); difflsmeans(lmer_ph)
lmer_p <- lmer(p_ppm ~ site*nitrogen + (1|block:site), data = master); anova(lmer_p); difflsmeans(lmer_p)
lmer_n <- lmer(per_N ~ site*nitrogen + (1|block:site), data = master); anova(lmer_n); difflsmeans(lmer_n)
lmer_c <- lmer(per_C ~ site*nitrogen + (1|block:site), data = master); anova(lmer_c); difflsmeans(lmer_c)
lmer_cn <- lmer(cn_ratio ~ site*nitrogen + (1|block:site), data = master); anova(lmer_cn); difflsmeans(lmer_cn)
lmer_cec <- lmer(est_cec ~ site*nitrogen + (1|block:site), data = master); anova(lmer_cec); difflsmeans(lmer_cec)
```

* rarefied richness and richness differ by site (p = 0.0107) as follows: Oregon and Hancock > Rhinelander.
* diveristy did not differ by site or N treatment. 

```{r lmer_div, results = 'hide', eval = FALSE}
lmer_rar <- lmer(div_rar ~ site*nitrogen + (1|block:site), data = master); anova(lmer_rar); difflsmeans(lmer_rar)
plot(lmer_rar)
lmer_rich <- lmer(div_rich ~ site*nitrogen + (1|block:site), data = master); anova(lmer_rich); difflsmeans(lmer_rich)
plot(lmer_rich)
lmer_shan <- lmer(div_shan ~ site*nitrogen + (1|block:site), data = master); anova(lmer_shan); difflsmeans(lmer_shan)
plot(lmer_shan)
lmer_simp <- lmer(div_simp ~ site*nitrogen + (1|block:site), data = master); anova(lmer_simp); difflsmeans(lmer_simp)
plot(lmer_simp)
```

## Negative Binomial Model Analysis 

This analysis follows the [`phyloseq` tutorial](https://bioconductor.org/packages/devel/bioc/vignettes/phyloseq/inst/doc/phyloseq-mixture-models.html) by Paul J. McMurdie and Susan Holmes.

OTUs 53 and 88 increased with N addition, OTUs 3 and 4 decreased. 

* OTU 53 - unknown Glomeraceae
* OTU 88 - Paraglomus aff. laccatum
* OTU 3 - unknown Glomeraceae (different)
* OTU 4 - Paraglomus sp. 

```{r phyloseq}
info$nitrogen <- relevel(info$nitrogen, ref = "control")
physeq <- phyloseq(otu_table(otu, taxa_are_rows = FALSE), sample_data(info))
```

```{r deseq}
physeq <- prune_samples(sample_sums(physeq) > 500, physeq)
dseq <- phyloseq_to_deseq2(physeq, ~ nitrogen + site)
gm_mean <- function(x, na.rm = TRUE){
  exp(sum(log(x[x > 0]), na.rm = na.rm) / length(x))
}
geoMeans <- apply(counts(dseq), 1, gm_mean)
dseq_geo = estimateSizeFactors(dseq, geoMeans = geoMeans)
dseq_geo = DESeq(dseq_geo, fitType="local")
```

```{r deseq_results}
res <- results(dseq_geo)
res <- res[order(res$padj, na.last = NA), ]
alpha <- 0.01
sigtab <- res[(res$padj < alpha), ]
sigtab
```

```{r pos_neg_significance_tables}
posigtab <- sigtab[sigtab[, "log2FoldChange"] > 0, ]
posigtab <- posigtab[, c("baseMean", "log2FoldChange", "lfcSE", "padj")]
posigtab
negsigtab <- sigtab[sigtab[, "log2FoldChange"] < 0, ]
negsigtab <- negsigtab[, c("baseMean", "log2FoldChange", "lfcSE", "padj")]
negsigtab
```

## Ordination

```{r nmds, eval = FALSE}
# clean
physeq_trans <- transform_sample_counts(physeq, function(x) 1E6 * x/sum(x))
# plot ASVs
physeq_trans_ord <- ordinate(physeq_trans, "NMDS", "bray")
p1 <- plot_ordination(physeq_trans, physeq_trans_ord, type="taxa", color="Order", title="taxa")
print(p1)
# plot samples
p2 <- plot_ordination(physeq_filt_trans, physeq_filt_trans_ord, type="samples", color="site", title="Nirogen")
print(p2)
```

```{r nmds_filt}
# clean
physeq
filt <- genefilter_sample(physeq, filterfun_sample(function (x) x > 20))
physeq_filt <- prune_taxa(filt, physeq)
physeq_filt
physeq_filt_trans <- transform_sample_counts(physeq_filt, function(x) 1E6 * x/sum(x))
physeq_filt_trans
# plot ASVs
physeq_filt_trans_ord <- ordinate(physeq_filt_trans, "NMDS", "bray")
p1 <- plot_ordination(physeq_filt_trans, physeq_filt_trans_ord, type="taxa", color="Genus", title="taxa")
print(p1)
# plot samples
p2 <- plot_ordination(physeq_filt_trans, physeq_filt_trans_ord, type="samples", color="site", title="NMDS Ordination of ASV Communities", shape = "nitrogen")
print(p2)
```

```{r nmds_filt_biplot, eval = FALSE}
p3 <- plot_ordination(physeq_filt_trans, physeq_filt_trans_ord, type="biplot", color="site", shape="Family", title="biplot")
# Some stuff to modify the automatic shape scale
GP1.shape.names = get_taxa_unique(physeq_filt_trans, "Family")
GP1.shape <- 15:(15 + length(GP1.shape.names) - 1)
names(GP1.shape) <- GP1.shape.names
GP1.shape["samples"] <- 16
p3 + scale_shape_manual(values=GP1.shape)

p4 <- plot_ordination(physeq_filt_trans, physeq_filt_trans_ord, type="split", color="Family", shape="nitrogen", label="site", title="split") 
p4
```

